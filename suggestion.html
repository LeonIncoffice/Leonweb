<!DOCTYPE html>
<html lang="zh">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>提交建议</title>
    <style>
        body {
            font-family: 'Roboto', sans-serif;
            background-color: #f5f5f5;
            color: #333;
            margin: 0;
            padding: 0;
        }

        .container {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            max-width: 800px;
            width: 90%;
            margin: 20px auto;
        }

        h1, h2, h3 {
            text-align: center;
            margin-bottom: 20px;
        }

        form {
            display: flex;
            flex-direction: column;
        }

        textarea {
            resize: vertical;
            padding: 10px;
            font-size: 16px;
            border-radius: 5px;
            border: 1px solid #ccc;
            margin-bottom: 20px;
            min-height: 150px;
        }

        button {
            background-color: #007BFF;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            margin: 5px 0;
        }

        button:hover {
            background-color: #0056b3;
        }

        .response {
            margin-top: 20px;
            padding: 10px;
            background-color: #f1f1f1;
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }

        .ip-info {
            font-size: 12px;
            color: #777;
            text-align: center;
            margin-top: 20px;
        }

        .message-list {
            margin-top: 30px;
            border-top: 1px solid #ddd;
            padding-top: 20px;
        }

        .message-item {
            padding: 15px;
            margin-bottom: 15px;
            background-color: #f9f9f9;
            border-radius: 5px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .message-content {
            margin-bottom: 10px;
        }

        .message-date {
            font-size: 12px;
            color: #777;
            margin-bottom: 10px;
        }

        .message-reply {
            background-color: #e8f4ff;
            padding: 10px;
            border-radius: 5px;
            margin-top: 10px;
            border-left: 3px solid #007BFF;
        }

        .loading {
            text-align: center;
            margin: 20px 0;
            color: #777;
        }

        .toggle-button {
            background-color: #6c757d;
            margin: 20px auto;
            display: block;
        }

        .debug-info {
            font-size: 12px;
            color: #999;
            margin-top: 10px;
            padding: 10px;
            background-color: #f8f9fa;
            border-radius: 5px;
            white-space: pre-wrap;
            word-break: break-all;
        }

        .retry-button {
            background-color: #28a745;
            color: white;
            padding: 8px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            margin-top: 10px;
        }
        
        .message-number {
            font-size: 12px;
            color: #6c757d;
            font-weight: bold;
            margin-bottom: 5px;
        }
    </style>
</head>

<body>
    <div class="container">
        <h1>反馈系统</h1>
        
        <form id="suggestionForm">
            <textarea id="suggestion" placeholder="请输入您的建议..."></textarea>
            <button type="submit">提交</button>
        </form>
        <div class="response" id="response"></div>
        <div class="ip-info" id="ip-info">正在获取您的IP...</div>
        
        <button id="toggle-messages" class="toggle-button">查看历史留言和回复</button>
        
        <div class="message-list" id="message-list" style="display: none;">
            <div class="loading" id="loading-messages">正在加载留言...</div>
            <div class="debug-info" id="debug-info"></div>
        </div>
    </div>

    <script>
        // 记录用户IP
        let userIP = '';
        let loadingAttempts = 0;
        const MAX_LOADING_ATTEMPTS = 3;
        
        // 获取用户IP - 使用多种方法提高成功率
        async function fetchUserIP() {
            const ipInfo = document.getElementById('ip-info');
            ipInfo.textContent = '正在获取您的IP...';
            
            try {
                // 首先尝试使用Cloudflare Workers自己的API
                const cfResponse = await fetch('https://morning-snow-5502.leonhelp999-org.workers.dev/get-client-ip');
                if (cfResponse.ok) {
                    const cfData = await cfResponse.json();
                    if (cfData.ip && cfData.ip !== '未知IP') {
                        userIP = cfData.ip;
                        ipInfo.textContent = `您的IP: ${userIP}`;
                        return;
                    }
                }
                
                // 如果Cloudflare API失败，尝试ipify
                const ipifyResponse = await fetch('https://api.ipify.org?format=json');
                if (ipifyResponse.ok) {
                    const ipifyData = await ipifyResponse.json();
                    if (ipifyData.ip) {
                        userIP = ipifyData.ip;
                        ipInfo.textContent = `您的IP: ${userIP}`;
                        
                        // 将IP发送到服务器
                        await recordIP(userIP);
                        return;
                    }
                }
                
                // 如果ipify也失败，尝试其他服务
                const ipApiResponse = await fetch('https://ipapi.co/json/');
                if (ipApiResponse.ok) {
                    const ipApiData = await ipApiResponse.json();
                    if (ipApiData.ip) {
                        userIP = ipApiData.ip;
                        ipInfo.textContent = `您的IP: ${userIP}`;
                        
                        // 将IP发送到服务器
                        await recordIP(userIP);
                        return;
                    }
                }
                
                // 所有方法都失败
                ipInfo.textContent = '无法获取您的IP，但您仍可以提交反馈';
                
            } catch (error) {
                console.error('获取IP失败:', error);
                ipInfo.textContent = '无法获取您的IP，但您仍可以提交反馈';
            }
        }
        
        // 记录IP到服务器
        async function recordIP(ip) {
            if (!ip) return;
            
            try {
                await fetch('https://morning-snow-5502.leonhelp999-org.workers.dev/record-ip', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ ip: ip })
                });
            } catch (error) {
                console.error('记录IP失败:', error);
            }
        }

        // 提交建议表单
        document.getElementById('suggestionForm').addEventListener('submit', async function (e) {
            e.preventDefault();
            const responseDiv = document.getElementById('response');
            const suggestion = document.getElementById('suggestion').value;

            if (!suggestion.trim()) {
                responseDiv.textContent = '请输入建议内容';
                responseDiv.style.display = 'block';
                return;
            }

            responseDiv.textContent = '正在提交...';
            responseDiv.style.display = 'block';

            try {
                const response = await fetch('https://morning-snow-5502.leonhelp999-org.workers.dev/submit-suggestion', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ suggestion, ip: userIP })
                });
                
                if (!response.ok) {
                    throw new Error(`服务器返回错误: ${response.status}`);
                }
                
                const data = await response.json();
                responseDiv.textContent = data.message;
                document.getElementById('suggestion').value = '';
                
                // 刷新留言列表（如果已显示）
                if (document.getElementById('message-list').style.display !== 'none') {
                    loadMessages();
                }
            } catch (error) {
                console.error('提交失败:', error);
                
                // 尝试保存到本地
                const savedLocally = saveMessageToLocal(suggestion);
                
                if (savedLocally) {
                    responseDiv.textContent = '无法连接到服务器，但您的留言已保存在本地。当服务器恢复时，您可以尝试再次提交。';
                    document.getElementById('suggestion').value = '';
                } else {
                    responseDiv.textContent = '提交失败: ' + error.message + '。无法保存到本地存储。';
                }
                
                // 添加重试按钮
                const retryButton = document.createElement('button');
                retryButton.textContent = '重试提交';
                retryButton.style.marginTop = '10px';
                retryButton.onclick = function() {
                    document.getElementById('suggestionForm').dispatchEvent(new Event('submit'));
                };
                responseDiv.appendChild(retryButton);
            }
        });
        
        // 加载留言和回复
        async function loadMessages() {
            const messageList = document.getElementById('message-list');
            const loadingElement = document.getElementById('loading-messages');
            const debugInfo = document.getElementById('debug-info');
            
            loadingElement.style.display = 'block';
            loadingElement.textContent = `正在加载留言...${loadingAttempts > 0 ? `(第${loadingAttempts + 1}次尝试)` : ''}`;
            
            // 清除现有留言和调试信息
            const existingMessages = messageList.querySelectorAll('.message-item');
            existingMessages.forEach(item => item.remove());
            
            // 移除之前的重试按钮
            const existingRetryButton = messageList.querySelector('.retry-button');
            if (existingRetryButton) {
                existingRetryButton.remove();
            }
            
            // 显示调试信息（始终可见，方便排查问题）
            debugInfo.style.display = 'block';
            debugInfo.textContent = '正在连接服务器...';
            
            try {
                console.log('开始加载留言...');
                
                // 设置超时
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 15000); // 15秒超时
                
                // 先检查服务器状态
                try {
                    const statusResponse = await fetch('https://morning-snow-5502.leonhelp999-org.workers.dev/debug-status', {
                        signal: controller.signal
                    }).catch(error => {
                        throw error;
                    });
                    
                    if (statusResponse.ok) {
                        const statusData = await statusResponse.json();
                        debugInfo.textContent = `服务器状态: 正常\n留言数量: ${statusData.suggestions.length}\n`;
                    }
                } catch (statusError) {
                    console.error('检查服务器状态失败:', statusError);
                    debugInfo.textContent = `服务器状态检查失败: ${statusError.message}\n尝试继续加载留言...`;
                }
                
                const response = await fetch('https://morning-snow-5502.leonhelp999-org.workers.dev/view-suggestions', {
                    signal: controller.signal
                }).catch(error => {
                    clearTimeout(timeoutId);
                    throw error;
                });
                
                clearTimeout(timeoutId);
                
                console.log('收到服务器响应:', response.status, response.statusText);
                debugInfo.textContent += `\n响应状态: ${response.status} ${response.statusText}`;
                
                if (!response.ok) {
                    throw new Error(`服务器返回错误: ${response.status} ${response.statusText}`);
                }
                
                // 获取响应文本用于调试
                const responseText = await response.text();
                console.log('响应内容长度:', responseText.length);
                
                // 显示调试信息
                debugInfo.textContent += `\n响应内容长度: ${responseText.length}字节`;
                if (responseText.length > 0) {
                    debugInfo.textContent += `\n响应内容预览: ${responseText.substring(0, 100)}${responseText.length > 100 ? '...' : ''}`;
                } else {
                    debugInfo.textContent += '\n响应内容为空';
                    throw new Error('服务器返回了空内容');
                }
                
                // 尝试解析JSON
                let messages;
                try {
                    messages = JSON.parse(responseText);
                    console.log('解析后的消息:', messages);
                    debugInfo.textContent += '\nJSON解析成功';
                } catch (parseError) {
                    console.error('JSON解析失败:', parseError);
                    debugInfo.textContent += `\nJSON解析错误: ${parseError.message}`;
                    
                    // 尝试修复常见的JSON格式问题
                    try {
                        // 检查是否是HTML响应
                        if (responseText.trim().startsWith('<!DOCTYPE') || responseText.trim().startsWith('<html')) {
                            debugInfo.textContent += '\n收到了HTML响应而非JSON，可能是服务器配置问题';
                            throw new Error('服务器返回了HTML而非JSON数据');
                        }
                        
                        // 尝试修复JSON格式
                        const fixedText = responseText
                            .replace(/,\s*}/g, '}')  // 移除对象末尾多余的逗号
                            .replace(/,\s*]/g, ']'); // 移除数组末尾多余的逗号
                        
                        messages = JSON.parse(fixedText);
                        debugInfo.textContent += '\n修复JSON格式后解析成功';
                    } catch (fixError) {
                        throw new Error(`无法解析服务器响应: ${parseError.message}`);
                    }
                }
                
                // 确保messages是数组
                if (!Array.isArray(messages)) {
                    console.error('收到的数据不是数组:', messages);
                    debugInfo.textContent += `\n收到的数据不是数组: ${JSON.stringify(messages)}`;
                    
                    // 尝试从对象中提取数组
                    if (messages && typeof messages === 'object') {
                        for (const key in messages) {
                            if (Array.isArray(messages[key])) {
                                console.log(`从对象的${key}属性中找到数组`);
                                debugInfo.textContent += `\n从对象的${key}属性中找到数组`;
                                messages = messages[key];
                                break;
                            }
                        }
                    }
                    
                    // 如果仍然不是数组，尝试将其转换为数组
                    if (!Array.isArray(messages)) {
                        if (messages && typeof messages === 'object') {
                            // 尝试将对象转换为数组
                            const tempArray = [];
                            for (const key in messages) {
                                if (typeof messages[key] === 'object') {
                                    tempArray.push(messages[key]);
                                }
                            }
                            if (tempArray.length > 0) {
                                messages = tempArray;
                                debugInfo.textContent += '\n已将对象转换为数组';
                            } else {
                                // 如果无法转换，创建一个包含原始对象的数组
                                messages = [messages];
                                debugInfo.textContent += '\n已将对象包装为数组';
                            }
                        } else {
                            // 如果不是对象也不是数组，创建空数组
                            messages = [];
                            debugInfo.textContent += '\n无法处理的数据类型，已创建空数组';
                        }
                    }
                }
                
                // 清除加载提示
                loadingElement.style.display = 'none';
                
                if (messages.length === 0) {
                    const noMessagesElement = document.createElement('div');
                    noMessagesElement.className = 'message-item';
                    noMessagesElement.innerHTML = '<div class="message-content">暂无留言</div><div class="message-date">您可以在上方表单提交新的留言</div>';
                    messageList.appendChild(noMessagesElement);
                    debugInfo.textContent += '\n留言列表为空';
                    return;
                }
                
                debugInfo.textContent += `\n成功加载 ${messages.length} 条留言`;
                
                // 按时间倒序排序，最新的在前面
                messages.sort((a, b) => {
                    const dateA = a.timestamp ? new Date(a.timestamp) : new Date(0);
                    const dateB = b.timestamp ? new Date(b.timestamp) : new Date(0);
                    return dateB - dateA;
                });
                
                // 显示留言
                messages.forEach((msg, index) => {
                    const messageItem = document.createElement('div');
                    messageItem.className = 'message-item';
                    
                    const content = document.createElement('div');
                    content.className = 'message-content';
                    content.textContent = msg.content || (typeof msg === 'string' ? msg : JSON.stringify(msg));
                    
                    const date = document.createElement('div');
                    date.className = 'message-date';
                    date.textContent = msg.timestamp ? new Date(msg.timestamp).toLocaleString('zh-CN') : '未知时间';
                    
                    const msgNumber = document.createElement('div');
                    msgNumber.className = 'message-number';
                    msgNumber.textContent = `#${index + 1}`;
                    
                    messageItem.appendChild(msgNumber);
                    messageItem.appendChild(content);
                    messageItem.appendChild(date);
                    
                    // 添加IP信息（如果有）
                    if (msg.ip) {
                        const ipInfo = document.createElement('div');
                        ipInfo.className = 'message-date';
                        ipInfo.textContent = `IP: ${msg.ip}`;
                        messageItem.appendChild(ipInfo);
                    }
                    
                    // 添加回复区域
                    if (msg.replies && msg.replies.length > 0) {
                        msg.replies.forEach(reply => {
                            const replyDiv = document.createElement('div');
                            replyDiv.className = 'message-reply';
                            replyDiv.innerHTML = `<strong>管理员回复 (${new Date(reply.timestamp).toLocaleString('zh-CN')})：</strong> ${reply.content}`;
                            messageItem.appendChild(replyDiv);
                        });
                    }
                    
                    messageList.appendChild(messageItem);
                });
                
                // 重置尝试次数
                loadingAttempts = 0;
                
            } catch (error) {
                console.error('加载留言失败:', error);
                loadingElement.textContent = `加载失败: ${error.message}`;
                debugInfo.textContent += `\n错误: ${error.message}`;
                
                // 添加重试按钮
                if (loadingAttempts < MAX_LOADING_ATTEMPTS) {
                    const retryButton = document.createElement('button');
                    retryButton.className = 'retry-button';
                    retryButton.textContent = '重试加载';
                    retryButton.onclick = function() {
                        loadingAttempts++;
                        loadMessages();
                    };
                    messageList.appendChild(retryButton);
                    
                    // 添加手动输入留言按钮
                    const manualButton = document.createElement('button');
                    manualButton.className = 'retry-button';
                    manualButton.style.backgroundColor = '#6c757d';
                    manualButton.style.marginLeft = '10px';
                    manualButton.textContent = '直接提交新留言';
                    manualButton.onclick = function() {
                        document.getElementById('message-list').style.display = 'none';
                        document.getElementById('toggle-messages').textContent = '查看历史留言和回复';
                        document.getElementById('suggestion').focus();
                    };
                    messageList.appendChild(manualButton);
                } else {
                    loadingElement.textContent += '。已达到最大重试次数，请稍后再试。';
                    loadingAttempts = 0;
                    
                    // 检查是否有本地存储的留言
                    const localMessages = getLocalMessages();
                    if (localMessages.length > 0) {
                        // 添加显示本地留言的按钮
                        const showLocalButton = document.createElement('button');
                        showLocalButton.className = 'retry-button';
                        showLocalButton.style.backgroundColor = '#17a2b8';
                        showLocalButton.textContent = '显示本地留言';
                        showLocalButton.onclick = function() {
                            displayLocalMessages();
                        };
                        messageList.appendChild(showLocalButton);
                        
                        // 自动显示本地留言
                        setTimeout(() => {
                            displayLocalMessages();
                        }, 1000);
                    } else {
                        // 添加服务器状态检查按钮
                        const checkServerButton = document.createElement('button');
                        checkServerButton.className = 'retry-button';
                        checkServerButton.style.backgroundColor = '#dc3545';
                        checkServerButton.textContent = '检查服务器状态';
                        checkServerButton.onclick = checkServerStatus;
                        messageList.appendChild(checkServerButton);
                        
                        // 添加显示示例数据的按钮
                        const showDemoButton = document.createElement('button');
                        showDemoButton.className = 'retry-button';
                        showDemoButton.style.backgroundColor = '#6c757d';
                        showDemoButton.style.marginLeft = '10px';
                        showDemoButton.textContent = '显示示例留言';
                        showDemoButton.onclick = function() {
                            displayDemoMessages();
                        };
                        messageList.appendChild(showDemoButton);
                        
                        // 自动显示示例数据
                        setTimeout(() => {
                            displayDemoMessages();
                        }, 1000);
                    }
                }
            }
        }
        
        // 切换留言列表显示
        document.getElementById('toggle-messages').addEventListener('click', function() {
            const messageList = document.getElementById('message-list');
            const toggleButton = document.getElementById('toggle-messages');
            
            if (messageList.style.display === 'none') {
                messageList.style.display = 'block';
                toggleButton.textContent = '隐藏历史留言和回复';
                loadMessages();
            } else {
                messageList.style.display = 'none';
                toggleButton.textContent = '查看历史留言和回复';
            }
        });
        
        // 添加本地存储功能
        function saveMessageToLocal(message) {
            try {
                // 获取现有的本地留言
                let localMessages = JSON.parse(localStorage.getItem('localMessages') || '[]');
                
                // 添加新留言
                localMessages.push({
                    content: message,
                    timestamp: new Date().toISOString(),
                    ip: userIP,
                    isLocal: true
                });
                
                // 保存回本地存储
                localStorage.setItem('localMessages', JSON.stringify(localMessages));
                
                return true;
            } catch (error) {
                console.error('保存留言到本地失败:', error);
                return false;
            }
        }
        
        // 获取本地存储的留言
        function getLocalMessages() {
            try {
                return JSON.parse(localStorage.getItem('localMessages') || '[]');
            } catch (error) {
                console.error('获取本地留言失败:', error);
                return [];
            }
        }
        
        // 添加备用服务器检查功能
        async function checkServerStatus() {
            const debugInfo = document.getElementById('debug-info');
            debugInfo.style.display = 'block';
            debugInfo.textContent = '正在检查服务器状态...';
            
            try {
                // 创建超时控制器
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 5000); // 5秒超时
                
                // 尝试主服务器
                const response = await fetch('https://morning-snow-5502.leonhelp999-org.workers.dev/debug-status', {
                    signal: controller.signal
                }).catch(error => {
                    clearTimeout(timeoutId);
                    throw error;
                });
                
                clearTimeout(timeoutId);
                
                if (response.ok) {
                    const data = await response.json();
                    debugInfo.textContent = `服务器状态: 正常\n留言数量: ${data.suggestions.length}\n时间戳: ${data.timestamp}`;
                    return true;
                } else {
                    debugInfo.textContent = `主服务器返回错误: ${response.status} ${response.statusText}\n正在尝试备用方法...`;
                }
            } catch (error) {
                debugInfo.textContent = `主服务器连接失败: ${error.message}\n正在尝试备用方法...`;
            }
            
            // 如果主服务器失败，尝试其他端点
            try {
                // 创建超时控制器
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 5000); // 5秒超时
                
                const response = await fetch('https://morning-snow-5502.leonhelp999-org.workers.dev/get-client-ip', {
                    signal: controller.signal
                }).catch(error => {
                    clearTimeout(timeoutId);
                    throw error;
                });
                
                clearTimeout(timeoutId);
                
                if (response.ok) {
                    debugInfo.textContent += '\n备用端点可访问，服务器部分功能可能正常。';
                    return true;
                }
            } catch (error) {
                debugInfo.textContent += '\n备用端点也无法访问。';
            }
            
            // 如果所有在线检查都失败，显示本地存储的留言
            const localMessages = getLocalMessages();
            if (localMessages.length > 0) {
                debugInfo.textContent += `\n找到${localMessages.length}条本地保存的留言。`;
                
                // 添加显示本地留言的按钮
                const showLocalButton = document.createElement('button');
                showLocalButton.className = 'retry-button';
                showLocalButton.style.backgroundColor = '#17a2b8';
                showLocalButton.textContent = '显示本地留言';
                showLocalButton.onclick = function() {
                    displayLocalMessages();
                };
                document.getElementById('message-list').appendChild(showLocalButton);
            } else {
                debugInfo.textContent += '\n未找到本地保存的留言。';
                
                // 添加显示模拟数据的按钮
                const showDemoButton = document.createElement('button');
                showDemoButton.className = 'retry-button';
                showDemoButton.style.backgroundColor = '#6c757d';
                showDemoButton.textContent = '显示示例留言';
                showDemoButton.onclick = function() {
                    displayDemoMessages();
                };
                document.getElementById('message-list').appendChild(showDemoButton);
            }
            
            debugInfo.textContent += '\n\n可能的问题:\n1. 服务器已关闭或维护中\n2. 网络连接问题\n3. 域名已过期\n\n建议:\n- 稍后再试\n- 检查您的网络连接\n- 联系管理员';
            
            return false;
        }
        
        // 显示本地存储的留言
        function displayLocalMessages() {
            const messageList = document.getElementById('message-list');
            const loadingElement = document.getElementById('loading-messages');
            const debugInfo = document.getElementById('debug-info');
            
            // 清除现有留言
            const existingMessages = messageList.querySelectorAll('.message-item');
            existingMessages.forEach(item => item.remove());
            
            // 获取本地留言
            const localMessages = getLocalMessages();
            
            if (localMessages.length === 0) {
                const noMessagesElement = document.createElement('div');
                noMessagesElement.className = 'message-item';
                noMessagesElement.innerHTML = '<div class="message-content">暂无本地留言</div>';
                messageList.appendChild(noMessagesElement);
                return;
            }
            
            // 显示本地留言
            localMessages.forEach((msg, index) => {
                const messageItem = document.createElement('div');
                messageItem.className = 'message-item';
                messageItem.style.backgroundColor = '#fff8e1'; // 本地留言使用不同背景色
                
                const localBadge = document.createElement('div');
                localBadge.style.backgroundColor = '#ff9800';
                localBadge.style.color = 'white';
                localBadge.style.padding = '2px 5px';
                localBadge.style.borderRadius = '3px';
                localBadge.style.display = 'inline-block';
                localBadge.style.fontSize = '10px';
                localBadge.style.marginBottom = '5px';
                localBadge.textContent = '本地存储';
                
                const content = document.createElement('div');
                content.className = 'message-content';
                content.textContent = msg.content;
                
                const date = document.createElement('div');
                date.className = 'message-date';
                date.textContent = msg.timestamp ? new Date(msg.timestamp).toLocaleString('zh-CN') : '未知时间';
                
                messageItem.appendChild(localBadge);
                messageItem.appendChild(content);
                messageItem.appendChild(date);
                
                if (msg.ip) {
                    const ipInfo = document.createElement('div');
                    ipInfo.className = 'message-date';
                    ipInfo.textContent = `IP: ${msg.ip}`;
                    messageItem.appendChild(ipInfo);
                }
                
                // 添加重新提交按钮
                const resubmitButton = document.createElement('button');
                resubmitButton.className = 'retry-button';
                resubmitButton.style.backgroundColor = '#ff9800';
                resubmitButton.style.fontSize = '12px';
                resubmitButton.style.padding = '5px 10px';
                resubmitButton.textContent = '重新提交到服务器';
                resubmitButton.onclick = async function() {
                    try {
                        resubmitButton.textContent = '提交中...';
                        resubmitButton.disabled = true;
                        
                        const response = await fetch('https://morning-snow-5502.leonhelp999-org.workers.dev/submit-suggestion', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({ suggestion: msg.content, ip: userIP })
                        });
                        
                        if (!response.ok) {
                            throw new Error(`服务器返回错误: ${response.status}`);
                        }
                        
                        // 提交成功，从本地存储中删除
                        const localMessages = getLocalMessages();
                        const updatedMessages = localMessages.filter((m, i) => i !== index);
                        localStorage.setItem('localMessages', JSON.stringify(updatedMessages));
                        
                        // 更新UI
                        resubmitButton.textContent = '提交成功！';
                        resubmitButton.style.backgroundColor = '#28a745';
                        
                        // 3秒后刷新留言列表
                        setTimeout(() => {
                            loadMessages();
                        }, 3000);
                    } catch (error) {
                        resubmitButton.textContent = '提交失败，请重试';
                        resubmitButton.disabled = false;
                        console.error('重新提交失败:', error);
                    }
                };
                
                messageItem.appendChild(resubmitButton);
                messageList.appendChild(messageItem);
            });
            
            // 添加清除所有本地留言的按钮
            const clearButton = document.createElement('button');
            clearButton.className = 'retry-button';
            clearButton.style.backgroundColor = '#dc3545';
            clearButton.style.marginTop = '20px';
            clearButton.textContent = '清除所有本地留言';
            clearButton.onclick = function() {
                if (confirm('确定要清除所有本地保存的留言吗？此操作不可撤销。')) {
                    localStorage.removeItem('localMessages');
                    displayLocalMessages(); // 刷新显示
                }
            };
            messageList.appendChild(clearButton);
        }
        
        // 显示模拟数据
        function displayDemoMessages() {
            const messageList = document.getElementById('message-list');
            const loadingElement = document.getElementById('loading-messages');
            loadingElement.style.display = 'none';
            
            // 清除现有留言
            const existingMessages = messageList.querySelectorAll('.message-item');
            existingMessages.forEach(item => item.remove());
            
            // 模拟数据
            const demoMessages = [
                {
                    content: "这是一条示例留言，用于演示界面效果。实际留言将从服务器加载。",
                    timestamp: new Date().toISOString(),
                    ip: "127.0.0.1",
                    replies: [
                        {
                            content: "这是管理员的回复示例。",
                            timestamp: new Date().toISOString()
                        }
                    ]
                },
                {
                    content: "另一条示例留言，展示多条留言的排列效果。",
                    timestamp: new Date(Date.now() - 86400000).toISOString(), // 1天前
                    ip: "192.168.1.1"
                },
                {
                    content: "第三条示例留言，包含多条回复。",
                    timestamp: new Date(Date.now() - 172800000).toISOString(), // 2天前
                    ip: "10.0.0.1",
                    replies: [
                        {
                            content: "第一条回复示例。",
                            timestamp: new Date(Date.now() - 86400000).toISOString()
                        },
                        {
                            content: "第二条回复示例。",
                            timestamp: new Date().toISOString()
                        }
                    ]
                }
            ];
            
            // 显示模拟留言
            demoMessages.forEach((msg, index) => {
                const messageItem = document.createElement('div');
                messageItem.className = 'message-item';
                messageItem.style.backgroundColor = '#f0f8ff'; // 示例留言使用不同背景色
                
                const demoBadge = document.createElement('div');
                demoBadge.style.backgroundColor = '#6c757d';
                demoBadge.style.color = 'white';
                demoBadge.style.padding = '2px 5px';
                demoBadge.style.borderRadius = '3px';
                demoBadge.style.display = 'inline-block';
                demoBadge.style.fontSize = '10px';
                demoBadge.style.marginBottom = '5px';
                demoBadge.textContent = '示例数据';
                
                const content = document.createElement('div');
                content.className = 'message-content';
                content.textContent = msg.content;
                
                const date = document.createElement('div');
                date.className = 'message-date';
                date.textContent = msg.timestamp ? new Date(msg.timestamp).toLocaleString('zh-CN') : '未知时间';
                
                const msgNumber = document.createElement('div');
                msgNumber.className = 'message-number';
                msgNumber.textContent = `#${index + 1}`;
                
                messageItem.appendChild(demoBadge);
                messageItem.appendChild(msgNumber);
                messageItem.appendChild(content);
                messageItem.appendChild(date);
                
                if (msg.ip) {
                    const ipInfo = document.createElement('div');
                    ipInfo.className = 'message-date';
                    ipInfo.textContent = `IP: ${msg.ip}`;
                    messageItem.appendChild(ipInfo);
                }
                
                // 添加回复区域
                if (msg.replies && msg.replies.length > 0) {
                    msg.replies.forEach(reply => {
                        const replyDiv = document.createElement('div');
                        replyDiv.className = 'message-reply';
                        replyDiv.innerHTML = `<strong>管理员回复 (${new Date(reply.timestamp).toLocaleString('zh-CN')})：</strong> ${reply.content}`;
                        messageItem.appendChild(replyDiv);
                    });
                }
                
                messageList.appendChild(messageItem);
            });
            
            // 添加提示信息
            const infoElement = document.createElement('div');
            infoElement.style.textAlign = 'center';
            infoElement.style.margin = '20px 0';
            infoElement.style.padding = '10px';
            infoElement.style.backgroundColor = '#e9ecef';
            infoElement.style.borderRadius = '5px';
            infoElement.style.fontSize = '14px';
            infoElement.innerHTML = '<strong>提示：</strong>这些是示例数据，仅用于演示界面效果。<br>实际留言将在服务器连接恢复后显示。';
            messageList.appendChild(infoElement);
            
            // 添加重试连接服务器的按钮
            const retryButton = document.createElement('button');
            retryButton.className = 'retry-button';
            retryButton.textContent = '重试连接服务器';
            retryButton.onclick = function() {
                loadMessages();
            };
            messageList.appendChild(retryButton);
        }
        
        // 页面加载时获取IP
        document.addEventListener('DOMContentLoaded', function() {
            fetchUserIP();
            
            // 添加服务器状态检查按钮
            const statusButton = document.createElement('button');
            statusButton.textContent = '检查服务器状态';
            statusButton.style.backgroundColor = '#17a2b8';
            statusButton.style.color = 'white';
            statusButton.style.border = 'none';
            statusButton.style.padding = '5px 10px';
            statusButton.style.borderRadius = '3px';
            statusButton.style.fontSize = '12px';
            statusButton.style.marginTop = '10px';
            statusButton.style.cursor = 'pointer';
            statusButton.onclick = checkServerStatus;
            
            document.getElementById('ip-info').appendChild(document.createElement('br'));
            document.getElementById('ip-info').appendChild(statusButton);
        });
    </script>
</body>

</html>
